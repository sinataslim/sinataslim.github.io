<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
    <title>NYC Street Map</title>
    <style>
        body {
            background-color: #191A1A;
        }
        h1 {
            color: #c4c4c4;
            font-family: Arial, Helvetica, sans-serif;
        }
        #mapid { 
            height: 500px;
            width: 1200px;
            display: block;
            margin: auto;
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(145,145,145,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #191a1a;
        }
        .info{
            color: #c4c4c4
        }
        .legend {
            line-height: 18px;
            color: #c4c4c4;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        #dropdown {
            width: 150px;
        }
    </style>
</head>
<body>
    <!-- Add heading for the visualization -->
	<h1>NYC Crime Forecast</h1>
	<!-- Create dropdown element here. Options should be added after reading in crime data file, they should not be created here.-->
	<label for="dropdown" style='color: #c4c4c4; font-family: Helvetica'>Select Month Of Year:</label>
    <select name="dropdown" id="dropdown" style='background-color: #c4c4c4'></select>
    <br><br>
    <div id="mapid"></div>
    <script>

        var map = L.map('mapid').setView([40.73, -73.93], 10);

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',
            tileSize: 512,
            maxZoom: 18,
            minZoom: 9,
            zoomOffset: -1,
            id: 'mapbox/dark-v10',
            accessToken: 'pk.eyJ1Ijoic2luYXRhc2xpbSIsImEiOiJja21zaWV6c2YwMDJtMnZsaTF1MXoyemlsIn0.pHwMxGbfNtPrQWbuyn8qBg'
        }).addTo(map);

        // initial dow loaded
        var moy = "Jan"
        
        //// specify stamen tile layer
        //var mapTileLayer = new L.StamenTileLayer("terrain");

        //// set the map centre, zoom and div-id
        //var map = new L.Map("mapid", {
        //    center: new L.LatLng(40.73, -73.93),
        //    zoom: 10,
        //    maxZoom: 18, //set to avoid error
        //    minZoom: 9
        //});
        //map.addLayer(mapTileLayer)

        // create a layer "NYC Boundary" and add the details later
        var NYCLayer = L.geoJSON().addTo(map)
        //New Layers
        var grid, info, legend

        // read the NYC coordinates and add to the NYCLayer
        var nyc = d3.json("NYCboundaries.json")
        var SqGrid = d3.json("squareGrid.json")
        var crimeData = d3.dsv(",", `${moy}.csv`, function(d) {
            return{
            id: +d.gridID,
            lon: parseFloat(d["Longitude Center"]),
            lat: parseFloat(d["Latitude Center"]),
            moy: +d.MonthOfYear,
            //dow: +d.DayOfWeek,
            poverty: parseFloat(d["% Poverty"]),
            label: +d.label
            }
        })
        
        
        Promise.all([nyc, SqGrid, crimeData]).then(ready)

        function ready(data) {
            
            var nycBoundary = data[0].features
            var squareGrid = data[1]
            var cData = data[2]

            //console.log(squareGrid)
            //console.log(cData)

            // add the data to the grid (combine cData with squareGrid)
            for(var i=0; i<cData.length; i++){
                var dc_id = cData[i].id //data cell id
                for(var j=0; j<squareGrid.features.length; j++){
                    // j is the grid cell id/index
                    if(dc_id==j){
                        squareGrid.features[j]["cData"]=cData[i]
                    }
                }
            }
            var cData0 = {id: "NA", lon: 0.0, lat: 0.0, moy: "NA", dow: "NA", poverty:"NA", label:0}
            // add empty cData to the rest of grid cells
            for(var j=0; j<squareGrid.features.length; j++){
                    if(!(squareGrid.features[j].hasOwnProperty("cData"))){
                        squareGrid.features[j]["cData"]=cData0
                    }
                }
            //console.log(squareGrid)
            

            // add NYC coordinates to NYCLayer
            NYCLayer.addData(nycBoundary)
            NYCLayer.setStyle({fillOpacity: 0.0, 
                               color: "red",
                               weight: 2})

            // extract NYC coords only
            //var coordsNYC = nycBoundary[0].geometry.coordinates[0]
            
            // get the extent [minX, minY, maxX, maxY] of NYC coords
            //var extent = [
            //d3.min(coordsNYC, function(d) { return d[0]}),
            //d3.min(coordsNYC, function(d) { return d[1]}),
            //d3.max(coordsNYC, function(d) { return d[0]}),
            //d3.max(coordsNYC, function(d) { return d[1]}),
            //]
            
            //// build the grid 
            //var bbox = extent
            //var cellSide = 0.2
            //var options = {
            //    units: 'kilometers',
            //    mask: turf.polygon([coordsNYC])
            //}
            //var squareGrid = turf.squareGrid(bbox, cellSide, options)
            //console.log(squareGrid)


            //>>>>>>>>>>>>>>>>>>>>>>>>>>> set the style for each grid cell>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            //get list of labels to set the colorScale domain    
            function getLabelList(cData){
                labels=[]
                for(var i=0; i<cData.length; i++){
                    labels.push(cData[i].label)
                }
                return labels
            }
            //console.log(d3.extent(getLabelList(cData)))

            var colorScale = d3.scaleQuantile()
                .domain(d3.extent(getLabelList(cData)))
                .range(["#fcae91", "#fb6a4a", "#de2d26", "#a50f15"])
            //console.log(colorScale.quantiles())
            //console.log(colorScale(12.75))

            function opacity(label){
                if (label==0){
                    return 0.0
                }else{
                    return .7
                }
            }

            //here feeature is the squareGrid
            function style (feature){
                //console.log(feature)
                return{
                    weight: .25,
                    color: "#2c2c2b",
                    fillColor: colorScale(feature.cData.label),
                    fillOpacity: opacity(feature.cData.label)}
            }
            //>>>>>>>>>>>>>>>>>>>>>>>>>>> set the style for each grid cell >>>>>>>>>>>>>>>>>>>>>>>>>
            //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            //>>>>>>>>>>>>>>>>>>>>>>>>>>> set the tooltip over mouseover >>>>>>>>>>>>>>>>>>>>>>>>>>>
            function getPoverty(props){
                if(props.poverty == "NA"){
                    return "N/A"
                }else{
                    return d3.format(",.2f")(props.poverty)
                }
            }
            
            info = L.control();

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
                this.update();
                return this._div;
            };

            // method that we will use to update the control based on feature properties passed
            info.update = function (props) {
                //console.log(props)
                this._div.innerHTML = '<h4>Hover Over The Grid</h4>' +  (props ?
                     'Predicted Crime: '+ props.label + '<br />Poverty%: ' + getPoverty(props) + ' '
                    : '');
            };

            info.addTo(map);
            //>>>>>>>>>>>>>>>>>>>>>>>>>>> set the tooltip over mouseover >>>>>>>>>>>>>>>>>>>>>>>>>>>>
            //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            //>>>>>>>>>>>>>>>>>>>>>>>>>>>  set the legend  >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function (map) {

                var bins = colorScale.quantiles() //get the bins based on which the cell color is assigned
                bins.unshift(1)

                var div = L.DomUtil.create('div', 'info legend'),
                  grades = bins,
                  labels = [];
                
                // loop through our density intervals and generate a label with a colored square for each interval
                div.innerHTML = '<h4>Predicted Crime</h4>' 
                for (var i = 0; i < grades.length; i++) {
                    div.innerHTML += 
                        '<i style="background:' + colorScale(grades[i] + 1) + '"></i> ' +
                        Math.round(grades[i]) + (grades[i + 1] ? '&ndash;' + Math.round(grades[i + 1]-1) + '<br>' : '+');
                }

                return div;
            };

            legend.addTo(map);

            //>>>>>>>>>>>>>>>>>>>>>>>>>>>  set the legend  >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            //>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

            //mouseover func
            function highlightFeature(e) {
                var layer = e.target;

                layer.setStyle({
                    weight: 5,
                    color: 'yellow',
                    //fillOpacity: 0.2
                });

                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }
                info.update(layer.feature.cData)//data you pass to the tooltip
            }

            //mouseout func
            function resetHighlight(e) {
                grid.resetStyle(e.target);
                info.update()
            }

            function onEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                });
            }
            
            // add the grid to the map (add another layer)
            grid = L.geoJSON(squareGrid, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map)

            // populate dropdown
            mArray = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
            d3.select("#dropdown")
                    .selectAll("option")
                    .data(mArray)
                    .enter()
                    .append("option")
                    .attr("value", function(d) { return d; })
                    .text(function(d) { return d; })
                    .property("selected", function(d){
                            return d === mArray[0]
                        });
            
            // dropdown dataset selection
            var dropDown = d3.select("#dropdown")
            dropDown.on("change", function() {
                moy = d3.select(this).property("value")
                update.call(update, moy)
                //console.log(moy)
            });
            
        }
        
        function update(moy) {
            map.removeLayer(grid)
            map.removeControl(info)
            map.removeControl(legend)
             // read the NYC coordinates and add to the NYCLayer
            var nyc = d3.json("NYCboundaries.json")
            var SqGrid = d3.json("squareGrid.json")
            var crimeData = d3.dsv(",", `${moy}.csv`, function(d) {
                return{
                id: +d.gridID,
                lon: parseFloat(d["Longitude Center"]),
                lat: parseFloat(d["Latitude Center"]),
                moy: +d.MonthOfYear,
                //dow: +d.DayOfWeek,
                poverty: parseFloat(d["% Poverty"]),
                label: +d.label
                }
            })

            Promise.all([nyc, SqGrid, crimeData]).then(ready)
            
        }






    </script>

    
    
</body>
</html>